# SERVER ACTION STANDARDS (Phase 4)\n\nThis guide defines how frontend server actions should be structured for PPUK v7.\n\n## Core Principles\n- Use `'use server'` at the top of every action file.\n- Validate all inputs with Zod. Fail fast with clear messages.\n- Always check auth (`getServerUser` or `supabase.auth.getUser`) and return a safe error if missing.\n- Enforce permissions via RPCs (`can_edit_property`, `can_view_property`) or helper checks; admin bypass allowed where appropriate.\n- Never throw from actionsâ€”return `{ success: boolean; error?: string; data?: unknown }` (or the local `ActionResult` type) consistently.\n- Revalidate affected paths (`revalidatePath`) after mutations.\n- Do not change backend RPC contracts; wrap or mock on the frontend if needed.\n\n## Return Shape\n- Success: `{ success: true, ...data }`\n- Failure: `{ success: false, error: '<user-friendly message>' }`\n- If using `ActionResult` (`{ success?: boolean; error?: string }`), set `success: true` explicitly on success.\n\n## Validation Pattern (example)\n```ts\nconst Schema = z.object({ propertyId: z.string().uuid(), name: z.string().min(1) });\nconst parsed = Schema.safeParse(input);\nif (!parsed.success) return { success: false, error: parsed.error.issues[0]?.message || 'Invalid input' };\n```\n\n## Auth & Permissions\n- Auth: `getServerUser()` or `supabase.auth.getUser()`; return `Not authenticated` if missing.\n- Permissions: check RPCs (e.g., `can_edit_property`) or role helpers; return `No permission` if denied.\n\n## Error Handling\n- Do not leak raw DB errors to users; log to console and return a generic message where needed.\n- Catch/try-catch around Supabase calls; provide fallback empty data for read actions where safe.\n\n## Revalidation\n- Call `revalidatePath` for the specific resource and any dashboards affected after a successful mutation.\n\n## File Organization\n- Action files live under `frontend/actions/*`.\n- Keep actions small and single-purpose.\n- Prefer sharing schemas/helpers across related actions to stay consistent.\n\n## Mock Mode\n- Do not change action signatures for mocks. Instead, wrap or branch internally when `NEXT_PUBLIC_USE_MOCKS=true` (if needed) without altering backend contracts.\n\n## Accessibility & Testing\n- Pair actions with clear UI error states; ensure forms show action errors.\n- Keep `data-testid` stable to support Playwright coverage.\n\n## When Adding New Actions\n- Add Zod schema.\n- Check auth/permissions.\n- Return consistent shape.\n- Revalidate paths.\n- Add minimal logging for unexpected errors.\n*** End Patch
