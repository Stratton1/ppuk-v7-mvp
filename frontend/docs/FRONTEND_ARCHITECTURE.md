# Frontend Architecture (Phase 6)\n\nAuthoritative overview of the PPUK v7 frontend (Next.js 16 App Router + Supabase).\n\n## Routing & Layouts\n- App Router structure: `(public)` for unauthenticated routes, `(app)` for authenticated experience, `(app)/admin` for admin-only, `(app)/dev` for internal tools.\n- Layout chain: `app/layout.tsx` → group layout → page. Keep data loading in server components by default; client components only for interactivity.\n- Shared shells: `components/app/AppShell*`, `AppSection`, `PageHeader`; prefer these over legacy layout components.\n\n## Data & Permissions\n- Auth/session: `lib/auth/server-user.ts` (`getServerUser`) builds `ServerUserSession` with `property_roles` and `isAdmin` flags. Do not bypass it.\n- Permissions: use RPCs (`can_view_property`, `can_edit_property`) and helpers in `lib/role-utils.ts`, `lib/roles/domain.ts`, `lib/permissions/documents.ts`.\n- Property tabs in `(app)/properties/[id]` derive from both dashboard role and property-specific permissions (viewer/editor).\n\n## Server Actions\n- Location: `frontend/actions/*` (one responsibility per file).\n- Pattern: `'use server'` → Zod validation → `getServerUser` → permission check → Supabase mutation → `revalidatePath` → `{ success, error?, data? }`.\n- Reference: `docs/SERVER_ACTION_STANDARDS.md`.\n\n## Mock Mode (client-only)\n- Toggle: `NEXT_PUBLIC_USE_MOCKS=true` switches browser client to `lib/mock-supabase`.\n- Data: `lib/mock-data.ts` provides users/properties/documents/media/issues; session stored in `localStorage` key `ppuk_mock_session`.\n- UX: `/dev/mock-users` page to pick mock identity (`data-testid` provided). Server components still hit real Supabase; mock mode is intended for client-side widgets and demos.\n\n## UI System\n- Tailwind + shadcn UI. Tokens in `styles/tokens.ts`; design rules in `docs/DESIGN_SYSTEM.md`.\n- Domain components live in `components/{property,dashboard,app,home,issues,documents,media,events,search}`. Prefer server components for data render, client for forms/dialogs/tabs.\n- Testing hooks: every interactive element should expose `data-testid`; empty/error states use deterministic IDs (admin pages, compare, watchlist, public passport, mock users).\n\n## Data Fetching & Performance\n- Server components perform initial data fetch; avoid client-side Supabase writes (enforce via server actions / RPCs).\n- Use batching where possible (e.g., compare page) and cache signed URLs via `lib/signed-url-cache.ts`.\n- Avoid N+1 loops; request explicit columns only. Keep public passport lean (hero + metadata + gallery + docs).\n\n## Testing Surface\n- Unit: pure helpers in `tests/unit` (mock auth/session, signed URL cache, role helpers).\n- Integration/RLS: `tests/integration` and `tests/rls` (require Supabase test env vars).\n- E2E: Playwright specs in `tests/e2e` (use `/api/test/reset` before each, login via `/test/login`). Mock-mode coverage at `tests/e2e/mock-users.spec.ts`.\n\n## Key Files\n- Routing: `app/(app)/*`, `app/(public)/*`, `app/api/*`.\n- Actions: `actions/*` (Zod + auth + permission + revalidate).\n- Auth: `lib/auth/*`, `lib/role-utils.ts`, `lib/roles/domain.ts`.\n- Mock: `lib/mock-data.ts`, `lib/mock-supabase.ts`, `/dev/mock-users` page.\n- Design: `styles/tokens.ts`, `docs/DESIGN_SYSTEM.md`, `components/ui/*`.\n*** End Patch
