# ROUTE MAP — Protected Routes Audit (Frontend)\n\nSummary of public vs protected routes, required roles, and notes for UX/auth flows. This is frontend-only; backend/RLS rules remain the source of truth.\n\n## Public Routes\n| Route | Purpose | Notes |\n| --- | --- | --- |\n| `/` | Marketing/home | Client layout `(public)`; no auth redirects. |\n| `/auth/login` (legacy) | Login form | Redirects to `/dashboard` when already authenticated. |\n| `/auth/register` | Registration | Public. |\n| `/auth/forgot-password`, `/auth/reset-password` | Recovery | Public. |\n| `/test/login` | Test login page | Public (used by Playwright). |\n| `/p/[slug]` | Public Property Passport | Must stay public; no proxy/redirects. |\n| `/search` | Public search | Public. |\n| `/public/* assets` | Static assets | Always public. |\n\n## Protected Routes (general app shell)\n_All routes under `(app)` now call `getSessionOrRedirect` via `(app)/layout` and redirect to `/auth/login?redirect=<path>` when unauthenticated._\n\n| Route | Requirement | Source | Notes |\n| --- | --- | --- | --- |\n| `/dashboard` | Authenticated | `app/(app)/dashboard/page.tsx` | Landing after login. |\n| `/properties` | Authenticated | `app/(app)/properties/page.tsx` | Lists properties user can access. |\n| `/properties/create` | Authenticated | `app/(app)/properties/create/page.tsx` | Uses server actions; assumes edit permission on creation. |\n| `/properties/[id]` | Authenticated + `can_view_property` | `app/(app)/properties/[id]/layout.tsx` | Now enforces `can_view_property`; shows AccessUnavailable if forbidden; redirects to login if unauth. |\n| `/properties/[id]/details` | Authenticated | `app/(app)/properties/[id]/details/page.tsx` | Inherits auth + can_view check from layout. |\n| `/properties/[id]/media` | Authenticated | `app/(app)/properties/[id]/media/page.tsx` | Inherits auth + can_view check; tab visibility uses role flags. |\n| `/properties/[id]/documents` | Authenticated | `app/(app)/properties/[id]/documents/page.tsx` | Same as above. |\n| `/properties/[id]/issues` | Authenticated | `app/(app)/properties/[id]/issues/page.tsx` | Same as above. |\n| `/properties/[id]/history` | Authenticated | `app/(app)/properties/[id]/history/page.tsx` | Same as above. |\n| `/properties/compare` | Authenticated | `app/(app)/properties/compare/page.tsx` | Handles restricted IDs with explicit messaging. |\n| `/invitations` | Authenticated | `app/(app)/invitations/page.tsx` | Uses app shell guard. |\n| `/tasks` | Authenticated | `app/(app)/tasks/page.tsx` | Guarded by app shell. |\n| `/watchlist` | Authenticated | `app/(app)/watchlist/page.tsx` | Guarded by app shell. |\n| `/settings`, `/dashboard/profile`, `/dashboard/security` | Authenticated | `app/(app)/settings/page.tsx`, etc. | Guarded by app shell. |\n| `/dev/*` | Authenticated (dev tools) | `app/(app)/dev/**` | Guarded by app shell; mock-users page is deprecated/readonly. |\n\n## Admin Routes\n| Route | Requirement | Source | Notes |\n| --- | --- | --- | --- |\n| `/admin` | Auth + admin | `app/(app)/admin/layout.tsx` + `AdminRouteGuard` | Redirects to login if unauth; to `/dashboard` if non-admin. |\n| `/admin/users`, `/admin/analytics`, `/admin/audit` | Auth + admin | Same guard | RPCs may be missing; guarded empty states prevent crashes. |\n\n## Auth Redirect Rules\n- Protected routes → redirect to `/auth/login?redirect=<current path>` when unauthenticated (handled in `(app)/layout` via `getSessionOrRedirect`).\n- Admin routes → redirect to `/auth/login?redirect=/admin` if unauthenticated; to `/dashboard` if not admin.\n- Public routes (`/`, `/auth/*`, `/p/[slug]`, `/search`, `/test/login`) must never redirect when unauthenticated.\n- Legacy `/auth/login` remains public and redirects to `/dashboard` when already signed in.\n\n## Known Issues / TODOs\n- Backend-dependent admin RPCs (`get_admin_dashboard_stats`, etc.) still needed; frontend shows empty states if absent.\n- Duplicate login routes (`/auth/login` legacy vs `(public)/auth/login`) remain; consolidate later.\n- Mock mode removed; `/dev/mock-users` is informational only.\n\n## Key Helpers\n- `getSessionOrRedirect` (in `lib/auth/server-user.ts`): used by `(app)/layout` and property layout to enforce auth and attach redirect target.\n- `AdminRouteGuard`: enforces admin role and redirects appropriately.\n- `AccessUnavailable`: client component used for forbidden property access (403-style messaging).\n*** End Patch
