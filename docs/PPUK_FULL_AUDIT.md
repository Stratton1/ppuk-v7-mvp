# Property Passport UK — Full Codebase Audit (v10)

## 1. Repository Overview
- **Purpose**: Next.js 16 (App Router) frontend for Property Passport UK with Supabase (Postgres + Storage + RLS) backend. No separate backend service; all DB/RPC/storage live in Supabase.
- **Structure**: Root configs + docs; `frontend/` contains the app, actions, components, hooks, lib, types, providers; `supabase/` holds migrations, seed, config; build artefacts (`frontend/.next/`) and vendored deps (`frontend/node_modules/`) are committed and should be removed.
- **State**: v7 schema migrated (legacy v6 tables dropped); roles/permissions refactored (owner/buyer/tenant statuses + editor/viewer permissions); RLS rebuilt; seed rewritten. Middleware replaced with `proxy.ts` (Next 16 convention). Open uncommitted edits: auth forms use `React.useActionState`, AppAvatar typo fix.
- **Environments**: `frontend/.env.local` contains real project anon key (public but still a secret boundary). No runtime config separation for prod/stage.

## 2. Complete File Index
Legend: (U)=used, (R)=remove/artefact, (M)=misplaced/misnamed, (D)=duplicated.

- **Root**
  - `package.json` (U/D): Next scripts pointing to `frontend` path (incorrect for Next CLI), duplicate of `frontend/package.json` with older @supabase/ssr version. Rationalise to single package manifest at `frontend/`.
  - `eslint.config.js` (M): Flat config pointing to root `tsconfig.json`; app uses `frontend/eslint.config.mjs`.
  - `tsconfig.json` (M): Points to `frontend/src/*` (path not used); Next uses `frontend/tsconfig.json`.
  - `tsconfig.tsbuildinfo`, `verify_schema.sql`, `vitest.config.ts`, `eslint.config.js` (U).
  - `BEGINNER_ROADMAP_BLUEPRINT.md` (U/doc), `docs/*` (see below).
  - `lovable`, `lovable-components` (R/empty placeholders).
- **Docs** (all U unless noted): `FULL_REPO_ANALYSIS.txt`, `codebase-audit-v7.md`, `SCHEMA_ARCHITECTURE_SPECIFICATION.md`, `AUTH_ROLE_ARCHITECTURE_SPECIFICATION.md`, `RLS_POLICY_PLAN.md`, `RLS_VERIFICATION_REPORT.md`, `SCHEMA_VERIFICATION_REPORT.md`, `LEGACY_SCHEMA_REMOVAL_PLAN.md`, `PPUK_V7_COMPLETE_BLUEPRINT{,_V2}.md`, `roadmap.md`, `CORE/concise/refresh/continue/...` etc. Useful but not authoritative; keep `README.md`, `CONTRIBUTING.md`; others can be consolidated.
- **Supabase**
  - `supabase/config.toml` (U) and `.temp/*` refs (R; generated by CLI, should be gitignored).
  - `supabase/migrations/*.sql` (U): Core schema, RLS, RPCs, storage buckets, alignment drops, roles/permissions/status migration.
  - `supabase/seed.sql` (U): v7-only seed data.
- **Frontend root**
  - `frontend/package.json`, `package-lock.json` (U): canonical manifest.
  - `frontend/tsconfig.json`, `eslint.config.mjs`, `tailwind.config.ts`, `postcss.config.mjs`, `next.config.ts`, `components.json`, `next-env.d.ts`, `.nvmrc`, `.gitignore` (U).
  - `frontend/.env.example` (U), `frontend/.env.local` (Sensitive: real anon key committed).
  - `frontend/proxy.ts` (U): Next 16 proxy replacing middleware.
  - `frontend/.next/**` (R/build artefact); `frontend/node_modules/**` (R/vendor).
- **Frontend/app (pages + API)**
  - `layout.tsx`, `providers.tsx`, `globals.css`, `favicon.ico` (U).
  - Marketing: `page.tsx` (U).
  - Auth: `auth/login/page.tsx`, `auth/login/login-form.tsx`; `auth/register/page.tsx`, `auth/register/register-form.tsx` (U).
  - Dashboard: `dashboard/page.tsx`, `dashboard/{loading,error}.tsx` (U).
  - Properties: `properties/page.tsx`, `{loading,error}.tsx`; `properties/create/page.tsx` (+ loading/error); `properties/[id]/page.tsx`, `/edit/page.tsx`, `{loading,error,not-found}.tsx` (U).
  - Public passport: `p/[slug]/page.tsx` (U).
  - Search: `search/page.tsx` (U).
  - Tasks: `tasks/page.tsx` (U, placeholder).
  - Invitations: `invitations/page.tsx` (U, placeholder).
  - Settings: `settings/page.tsx` (U, placeholder).
  - API routes: `api/me/route.ts`, `api/property-access/[propertyId]/route.ts` (U).
- **Frontend/actions (server actions)**
  - `upload-property-photo.ts`, `delete-property-media.ts`, `upload-property-document.ts`, `delete-property-document.ts`, `set-public-visibility.ts`, `grant-property-role.ts`, `revoke-property-role.ts`, `tasks.ts` (U; see auth/validation gaps).
- **Frontend/lib**
  - `supabase/{client.ts,server.ts}` (U), `auth/{actions.ts,middleware-helpers.ts,server-user.ts}`, `role-utils.ts`, `document-utils.ts`, `signed-url.ts`, `utils.ts` (U).
- **Frontend/providers**: `supabase-provider.tsx`, `query-provider.tsx` (U).
- **Frontend/hooks**: `useSupabase.ts`, `useUser.ts` (U).
- **Frontend/components**
  - Layout: `layout/{app-shell,navbar,sidebar,footer,global-search}.tsx`.
  - Dashboard: `dashboard/{property-card,recent-activity,activity-timeline,access-card,kpi-card}.tsx`.
  - App shared: `app/{AppAvatar,AppKPI,AppPageHeader,AppSection,SettingsForm,TasksList,InvitationsList,PropertyLayout}.tsx`.
  - Property: many (gallery, documents, access dialogs, tasks, forms, flags, events, meta, list/card).
  - Public passport: `public-passport/{public-hero,public-metadata,public-gallery,public-documents}.tsx`.
  - Home/marketing: `home/*` (hero, stats, personas, FAQ, etc.).
  - UI primitives: `ui/{button,input,textarea,label,card,dialog,badge,skeleton}.tsx`.
  - `protected-route.tsx` (unused?).
- **Frontend/types**: `supabase.ts` (generated), `auth.ts`, `forms.ts` (U).
- **Frontend/tests**: `tests/rls.spec.ts` (U, partial coverage).
- **Supabase verification**: `verify_schema.sql` (U).

## 3. Dependency Graph Analysis
- **Frontend dependencies**: Next 16, React 19, Supabase SSR + supabase-js, React Query 5, zod, tailwind, radix dialog, lucide icons. Duplicate manifests cause version drift (root uses @supabase/ssr 0.5 vs frontend 0.8; root scripts point to `next dev frontend` which is invalid).
- **Import graph (high level)**:
  - Pages import lib/supabase client (server or browser), lib/auth/server-user, role-utils, and UI components.
  - Actions import supabase server client, sometimes supabase-js direct (anon) instead of SSR helper.
  - Components mostly stateless; property components depend on property actions/role-utils; dashboard uses RPCs and storage.
- **Coupling**:
  - `DashboardPage` tightly couples data fetching, completion RPC calls, and signed URLs per property (N+1).
  - Property pages couple storage signing and RPC invocations inline.
  - Role/permission logic duplicated: SQL functions (`can_view_property`, etc.) and TS `role-utils.ts` need sync; drift risk.
- **Circular deps**: None detected in source; proxy -> role-utils -> types; pages import from role-utils but not cyclic.
- **Tight coupling risks**: Actions mix storage + DB + events; no service layer. Proxy auth only guards selected routes (missing tasks/invitations/settings/search).

## 4. React Component Tree
- **App shell**: `layout.tsx` → `Providers` (SupabaseProvider + QueryProvider) → `AppShell` → `navbar` + `sidebar` + children. All pages inherit.
- **Public landing**: `app/page.tsx` uses `home/*` components.
- **Auth**: Login/Register pages render `login-form`/`register-form` (client) using server actions (`auth/actions.ts`).
- **Dashboard**: Server component fetching properties, stakeholders, media, events; renders KPI cards, property cards, timeline, access cards.
- **Properties list/create/detail/edit**: Server components; use property components (meta, gallery, documents, tasks, access dialogs). Client dialogs trigger server actions.
- **Public passport**: Server component using Supabase RPC `get_public_property`; renders hero, metadata, gallery, documents.
- **Search**: Server component using supabase-js with anon key; renders list.
- **Tasks/Invitations/Settings**: Presentational placeholders (no data).
- **Client vs server**: Forms/dialogs correctly marked `'use client'`; most pages are server. Some client components misuse heavy logic? Acceptable.
- **Anti-patterns**: No global error boundaries; prop drilling minimal. Over-fetching and inline imperative code in pages (dashboard/property) rather than hooks/services. Client components call server actions with minimal validation.

## 5. Domain Model Reconstruction
- **Global users**: `users` table (id/email/full_name/avatar/organisation/primary_role enum user_primary_role: consumer, agent, conveyancer, surveyor, admin). `profiles` (phone/bio). `roles` catalog + `user_roles` mapping (legacy-ish).
- **Properties**: `properties` (id, uprn unique, display_address, lat/lng, status enum draft/active/archived, created_by_user_id, public_slug, public_visibility, soft-delete).
- **Per-property access**: `property_stakeholders` (user_id, property_id, role (enum owner/editor/viewer), status (owner/buyer/tenant), permission (editor/viewer), expires_at, soft-delete). Ownership also implied by created_by_user_id. Invitations mirror status/permission with token.
- **Documents/Media**: `documents` and `media` tables with bucket/path, mime, size, status, soft-delete; versions table for documents.
- **Events/Activity**: `property_events` generic event log; `activity_log` global (service-read only).
- **Metadata/Integrations**: `property_metadata` KV, `integrations` (type/status/payload).
- **Tasks**: Basic tasks table (status/priority/due/assign).
- **Notifications**: Basic notification table (read_at).
- **Derived helpers**: SQL helpers `is_property_owner/buyer/tenant/editor/viewer`, `can_view_property`, `can_edit_property`, `has_property_role`, etc.
- **Accuracy**: Model covers owner/buyer/tenant + permission; lacks chain position, conveyancer linkage, AML/KYC, document categories per UK regs (EPC/FENSA/boiler). No explicit transaction/pipeline entities. Invitations lack acceptance audit beyond status/timestamp. No document signing/audit.

## 6. Schema & Database Audit
- **Integrity**: Enums present; primary keys defined; unique on `properties.uprn`, `documents.storage_path`, etc. Soft-deletes on most tables.
- **Indexes**: Present on docs/media/tasks property_id; missing targeted indexes on `property_stakeholders (property_id)`, `property_stakeholders (user_id)`, `invitations (property_id)`, `property_events (property_id, created_at desc)` (only property_id). Add composite indexes for common filters (user_id, property_id, status/permission).
- **Constraints**: `properties.display_address` non-empty; documents/media non-empty path/title; tasks lack check on status/priority values (free-text). Invitations email not constrained to lower/unique per property.
- **Migrations**: Legacy drop migration present; role/status migrations overwrite helpers—ensure sequencing (20250315000000 then 20250320000000). Validate down-migrations absent (Supabase style).
- **Stored functions**: RPCs rebuilt; `calculate_property_completion` simplistic (weights). `set_public_visibility` allows editors/owners; no slug regen except client action. `grant_property_role` allows status/permission combination; ensures cannot remove last owner in revoke.
- **Storage buckets**: Both buckets created; storage policies overly broad (any authenticated user can insert/update/delete any object in bucket; no linkage to property or ownership; public select allowed for photos).
- **Data retention**: No cascade cleanup of storage objects on soft-delete; no triggers to version documents; no auditing on invitations acceptance beyond status flip.

## 7. Supabase RLS Audit
- **Helpers**: `is_service_role`, `is_admin`, `is_property_owner/buyer/tenant/editor/viewer`, `can_view_property`, `can_edit_property`, `can_upload`, `can_delete`, `can_invite`, `has_property_role`, `role_for_property`.
- **Policies (latest)**:
  - Properties: select via `can_view_property`; all (write/delete) via `can_edit_property`.
  - Stakeholders: select for self or inviter; all via `can_invite`.
  - Documents/Media: select via `can_view_property`; all via `can_upload`.
  - Tasks: select via `can_view_property`; all via `can_edit_property`.
  - Property events/metadata: select via `can_view_property`; insert/all via `can_edit_property`.
  - Invitations: select via `can_invite` or email match; all via `can_invite`.
  - Profiles: self/admin/service.
  - Notifications: select self/admin/service; no insert policy (effectively blocked except service).
  - Activity log: select admin/service only.
  - Integrations: select if property null or can view; all if can invite (owner/admin).
- **Gaps/Risks**:
  - Public visibility implies `can_view_property` true → documents/media/tasks become world-readable if property is public (no document-level override). Sensitive docs (EPC, identity) could leak. Need separate public-safe views or storage ACL.
  - Storage policies do not enforce RLS linkage; authenticated users can overwrite/delete arbitrary files in buckets.
  - No RLS on storage objects tied to `property_id` metadata.
  - Notifications insert/update blocked for non-service (maybe intentional but breaks UX).
  - Activity log write not covered (no policy) → inserts blocked except service (good? but app writes none).
  - `role_for_property`/`can_view_property` rely on auth.uid; anon allowed via public_visibility branch, but policy grants select to authenticated only; however `search_properties` RPC grants anon if public_visibility true, and property policies allow anon if can_view_property uses public visibility? It does not check auth uid? function includes public visibility but still executed under anon; policies allow anon? No policy grants anon role; only authenticated. Need explicit policy for anon if public_visibility true or use `authenticated` role only—current policy lacks `to public`, so anon cannot select via direct table, but RPC security definer bypasses. Documents/media policies allow authenticated only; anon cannot select even if public_visibility true, but storage policy allows public select on photos. Net: public read path via RPC + signed URLs; documents still require auth but any authenticated user (not scoped) once property public.
- **Server actions** rely on RLS; some use supabase anon key and auth session; no service role leaks.

## 8. Full API Catalogue
- **Next API routes**
  - `GET /api/me` (auth required): returns `ServerUserSession`; 401 if none. No caching.
  - `GET /api/property-access/:propertyId` (auth required): checks property visibility + role-utils; returns {access}. 403 on deny, 404 on missing.
- **Server actions (called from UI)**
  - Auth: `loginAction`, `registerAction`, `logoutAction`, `updateProfile` (in `lib/auth/actions.ts`); minimal validation, returns {error}.
  - Properties: `set_public_visibility` (RPC call + slug regen), `upload_property_photo`, `upload_property_document`, `delete_property_media/document`, `grant_property_role`, `revoke_property_role`, `createTaskAction`.
  - None of these enforce schema-level validation of file mimetypes beyond local checks; rely on RLS helpers and storage policies.
- **Supabase RPCs (DB)**
  - `create_property_with_role`, `update_property_with_event`, `search_properties`, `get_user_properties`, `get_recent_activity`, `get_dashboard_stats`, `calculate_property_completion`, `get_public_property`, `grant_property_role`, `revoke_property_role`, `invite_user_to_property`, `accept_invitation`, `set_public_visibility`, `regenerate_slug`.
- **Error handling**: API routes return structured JSON; server actions often return simple error strings; no error boundary UI aside from page-level error.tsx.

## 9. Security Threat Model
- **Credentials/secrets**: `frontend/.env.local` with real Supabase anon key committed. No service key exposure found now; but prior docs warned. Remove from repo; use env vars.
- **AuthN/AuthZ**:
  - Proxy only protects `/dashboard`, `/properties/*`, `/api/property-access/*`. Routes `/search`, `/settings`, `/tasks`, `/invitations` are unguarded but currently low-sensitivity; could leak future features.
  - Role checks duplicated in TS (`role-utils`) and SQL; drift risk → potential IDOR if frontend logic diverges from RLS.
  - Public visibility + `can_view_property` enables broad access; document/media policies grant any authenticated user read if property is public (IDOR risk for sensitive docs).
- **Storage**: Storage policies overly permissive (any authenticated insert/update/delete; public select for photos). No property binding → object enumeration/overwrite possible.
- **PII/Document leakage**: Documents table accessible to any authenticated user for public properties; storage URLs signed but if stored path known, RLS won’t block storage select for documents bucket (policies allow any authenticated user). EPC, IDs, contracts risk exposure.
- **CSRF**: Next server actions are same-origin; no explicit CSRF tokens, but App Router actions mitigate. API routes lack CSRF protection but expect credentials.
- **XSS**: Inputs not sanitized; display_address and meta displayed; Supabase data trusted. Low usage of `dangerouslySetInnerHTML` (none spotted).
- **SSRF**: No outbound fetch except internal Supabase/Next.
- **Rate limiting**: None on login/register, upload endpoints, search; brute-force risk.
- **Supply chain**: Vendored `node_modules` committed; root/ frontend package mismatch; depends on Supabase 2.78, Next 16.0.5 (ok), React 19.2. No lock in root, only frontend.
- **Build artefacts**: `.next` committed; may leak runtime paths and increase repo size.
- **Env handling**: Root tsconfig path mismatch could cause tooling to miss files; not security but operational.

## 10. Authentication & Authorisation Review
- **Auth flow**: Supabase auth; server actions call `supabase.auth` with anon client. No MFA, no password complexity enforced. Register inserts into `users` + `profiles` with primary_role default `consumer`; no email verification enforcement beyond Supabase default.
- **Session handling**: SSR client uses cookies; `getServerUser` fetches users/profiles/stakeholders/properties; no caching; returns `property_roles` map. Proxy uses `getServerUser` for gating.
- **Authorisation**:
  - Proxy missing guards for several authed pages; rely on pages themselves (many do not check).
  - Server actions rely on RLS; some pre-check `has_property_role` (upload photo) but storage policies can still allow misuse.
  - Role mutations (grant/revoke) depend on RPC RLS; UI lacks admin override logic beyond RPC.
  - Public passport uses `get_public_property` (public RPC) to fetch gallery/docs list; document storage still requires auth to fetch unless using signed URLs (not provided for docs).
- **IDOR**: Potential via public visibility allowing doc/media access for any authenticated user; proxy doesn’t check for `/search` etc. Signed URLs generated for media (photos) only; docs download likely direct from storage (risk).

## 11. Performance & Scalability Review
- **N+1**: Dashboard calls `calculate_property_completion` and signed URL per property (sequential). Property detail likely similar (per-file signed URLs). Should batch via RPC or parallel Promise.all with limited concurrency.
- **Queries**: `search_properties` uses `ilike` without trigram or FTS; no pagination beyond limit 50. `get_recent_activity` limit 100.
- **Indexes**: Missing indexes on `property_stakeholders.user_id`, `property_stakeholders.property_id,deleted_at`, `invitations.property_id`, `property_events(property_id, created_at desc)`, `documents(property_id, deleted_at)`, `media(property_id, deleted_at)`.
- **Storage**: No image resizing; raw files served via signed URLs; bandwidth risk.
- **Bundling**: Marketing components client? Most are server; minimal client JS (forms/dialog). No code splitting issues obvious.
- **Concurrency**: Server actions sequential; uploads not chunked; no retries.

## 12. Dead Code / Redundant Folders
- `frontend/.next/**`, `frontend/node_modules/**` (artefacts; delete/ignore).
- Root `package.json`, `tsconfig.json`, `eslint.config.js` (duplicates/misleading). Consolidate into `frontend/` or make monorepo properly.
- Docs: multiple overlapping blueprints/audits; consolidate to single up-to-date spec.
- `lovable/`, `lovable-components/` empty.
- `protected-route.tsx` appears unused.
- `frontend/.env.local` should not be committed; move to env.

## 13. Third-Party Dependency Risks
- **Versions**: Next 16.0.5, React 19.2 (current), Supabase-js 2.78 (ok), Supabase SSR 0.8 in frontend (root 0.5). React Query 5.90 (ok), zod 4.1 (beta-ish), tailwind 3.4.
- **Deprecated/unused**: Root deps unused by runtime; remove. Check for unused @supabase/auth-helpers (present but not referenced).
- **Security advisories**: Need `npm audit` (not run). Vendored node_modules increases exposure to stale packages.
- **Lockfiles**: Only `frontend/package-lock.json`; root lacks lock; align.

## 14. Naming Convention Audit
- Mixed role terms: `role_type` (legacy), `property_role_type`, `property_status_type`, `property_permission_type` coexist; TS uses `PropertyStatus/PropertyPermission`. Clean to single vocabulary.
- Files mostly kebab/slug; root scripts `dev/build/start` misnamed (pass `frontend` arg).
- Docs/blueprints use v6/v7 interchangeably; clarify.
- Storage buckets vs table names consistent.

## 15. Operational Readiness Review
- **Logging**: Minimal console.error in actions; no structured logging or Sentry. No tracing.
- **Monitoring**: None.
- **Error handling**: Page-level `error.tsx` for dashboard/properties; no global error boundary.
- **Rate limiting**: None (auth, uploads, search).
- **Backups/DR**: Not documented; Supabase managed.
- **CI/CD**: No working GitHub Actions observed (root workflow outdated per docs). No schema drift check in CI.
- **Secrets management**: Env committed; need environment separation.
- **Migrations**: Supabase migrations present; no automated plan/apply in CI; no rollback plan.

## 16. Compatibility and Deployment Concerns
- Root scripts `next dev frontend` invalid; should run inside frontend. Could break deployments.
- Proxy vs middleware: using `proxy.ts` (Next 16) but needs `next.config` enable? Provided; ensure vercel config uses it.
- Node version >=20.9 required. `.nvmrc` present (20.9.0).
- Duplicate manifests may confuse deploy pipelines.
- `.next` in repo may bloat build context.
- Supabase storage policies must be set server-side; ensure migrations applied.

## 17. Investor Red Flags
- Sensitive env committed; repo hygiene poor (node_modules, .next).
- Storage ACL too permissive; potential document/PII leakage for public properties.
- Authz gaps: proxy not guarding all authed pages; doc/media access for any authenticated user on public properties; storage RLS not property-scoped.
- Operational gaps: no CI, no monitoring, no rate limiting, minimal tests (single RLS test).
- Performance risk: N+1 RPC/signing on dashboard; unindexed queries.
- Architecture risk: duplication of role logic (SQL vs TS) and duplicate package roots.

## 18. “Make The Codebase Perfect” Plan
- **Security first**: Remove committed envs/build artefacts; tighten storage policies to property-scoped checks; add document/public visibility segregation; extend proxy protection.
- **Schema/RLS hardening**: Add missing indexes, normalize roles, enforce document/media access by property permission; create storage policies referencing metadata table (object name → property_id).
- **Auth/UX**: Add validation/rate limiting; protect all authed routes; align server actions with SQL helpers; consistent error surfaces.
- **Operational**: Clean repo, consolidate packages, add CI (lint/test/build/migrations/types), add monitoring/logging.
- **Performance**: Batch RPC calls, parallel signed URLs with concurrency limits, add FTS/trigram on addresses, paginate lists.
- **Docs**: Single source README/architecture; remove stale docs.

## 19. 48-Hour / 1–2 Week / 1–2 Month Refactor Roadmap
- **48 hours**
  - Remove `frontend/.env.local`, `.next`, `node_modules` from repo; add to .gitignore.
  - Consolidate to `frontend/package.json`; fix root scripts or remove root manifest.
  - Tighten proxy to guard `/settings`, `/tasks`, `/invitations`, `/search`, `/api/*` by default.
  - Fix storage policies: restrict insert/update/delete to owners/editors via `can_upload(property_id)` using object metadata (add `metadata.property_id` requirement); drop public select or limit to signed URLs.
  - Block documents/media select for non-viewers on public properties unless explicitly public-safe; add RLS check for auth role only.
  - Add missing DB indexes (`property_stakeholders` user_id/property_id/deleted_at, `invitations.property_id`, `property_events(property_id, created_at desc)`, `documents/media` on deleted_at).
  - Regenerate types after migrations; run `npm run lint`/`npm run build`.
- **1–2 weeks**
  - Add CI (GitHub Actions): lint, type-check, build, run vitest (RLS), run `supabase db diff`/`verify_schema`.
  - Implement storage object trigger to enforce property_id metadata and cleanup on delete; signed URL service for documents with audit logging.
  - Refactor dashboard/property data fetching to batch RPCs and signed URLs; add pagination to lists/search.
  - Expand tests: RLS matrix per role/status, API route tests, server action unit tests.
  - Harden auth forms with zod schemas, password policy, rate limiting (middleware/Upstash), reCAPTCHA optional.
  - Consolidate docs into `docs/ARCHITECTURE.md`, `SECURITY.md`, `RUNBOOK.md`; remove duplicates.
  - Align role vocabulary across SQL/TS; remove legacy enums/columns if unused (`role_type`).
- **1–2 months**
  - Introduce service layer (server actions calling shared domain services) to decouple pages from supabase-js.
  - Add monitoring/observability (Sentry/Logflare), structured logging, audit trail for invitations and document downloads.
  - Implement transaction lifecycle entities (offers, chain position, conveyancer linkage), document requirements (EPC/FENSA/boiler), and consent flows.
  - Build public-safe document model (explicit public documents vs private).
  - Add image processing/resizing pipeline; CDN caching.
  - Explore moving to monorepo layout or ensure single package root; add ADRs.

## 20. Final Recommendations & Sign-Off
- Clean the repo immediately (remove env/build/vendor; fix scripts) and tighten storage/RLS to prevent cross-tenant leakage.
- Protect all authenticated surfaces via proxy and/or in-page guards; ensure role checks come from SQL helpers only.
- Add indexes and batch data fetching to avoid N+1 on dashboard/property pages.
- Stand up CI with lint/build/RLS tests and schema drift detection; regenerate types automatically on migration.
- Consolidate documentation and naming to reduce cognitive load and investor risk. After these steps, proceed to deeper domain features and observability.
